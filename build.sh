#!/bin/bash
# ====================================================
# Render.com ビルドスクリプト
# AI Avatar REI - 依存関係のインストール
# ====================================================

set -e  # エラーが発生したら即座に終了

echo "🚀 ビルド開始..."

# ====================================================
# 1. Pythonバージョン確認
# ====================================================
echo "📌 Pythonバージョン:"
python --version

# ====================================================
# 2. pipのアップグレード
# ====================================================
echo "📦 pipをアップグレード中..."
pip install --upgrade pip setuptools wheel

# ====================================================
# 3. 基本依存関係のインストール
# ====================================================
echo "📦 requirements.txtから依存関係をインストール中..."
pip install -r requirements.txt

# ====================================================
# 4. ChromaDB関連のインストール（重要）
# ====================================================
echo "📦 ChromaDB関連をインストール中..."
pip install chromadb==0.4.22
pip install langchain==0.1.0
pip install langchain-community==0.0.10

# ====================================================
# 5. その他の依存関係
# ====================================================
echo "📦 追加の依存関係をインストール中..."
pip install tiktoken==0.5.2
pip install sentence-transformers==2.2.2

# ====================================================
# 6. データディレクトリの作成
# ====================================================
echo "📁 データディレクトリを作成中..."
mkdir -p data/chroma_db
mkdir -p uploads
mkdir -p static/media/thumbnails

# ====================================================
# 7. 権限設定
# ====================================================
echo "🔐 ディレクトリの権限を設定中..."
chmod -R 755 data
chmod -R 755 uploads
chmod -R 755 static

# ====================================================
# 8. インストール確認
# ====================================================
echo "✅ インストールされたパッケージを確認中..."
pip list | grep -E "chromadb|langchain|openai|azure|Flask" || true

# ====================================================
# 9. ビルド完了
# ====================================================
echo "🎉 ビルド完了！"
echo "📊 ディスク使用状況:"
du -sh data/ uploads/ static/ 2>/dev/null || echo "ディレクトリが空です"

exit 0

